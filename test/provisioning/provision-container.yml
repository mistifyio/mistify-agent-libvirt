- hosts: localhost
  connection: local
  tasks:
    - name: Create a started container
      lxc_container:
        name: go-mistify-libvirt-test
        container_log: true
        template: download
        state: started
        template_options: --dist ubuntu --arch amd64 --release trusty
        config: "$HOME/.config/lxc/default.conf"
        container_command: |
          apt-get update
          apt-get install -y openssh-server apt-transport-https
          mkdir -p /root/.ssh
          mkdir -p {{lxc_user_home}}/.ssh
          chown -R {{lxc_user}}:{{lxc_user_group}} {{lxc_user_home}}/.ssh
          echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCOZAvvd4r7P0wAzx4vIhO7WtwhCE+LySBjV5q9hgR70ccWjVCL+OaK2LqohlL4QdwMOSsUcybwekl3gVtIIMPhqfp+vWM2QeMUO7bnU69mawYkb0EhJLUfNgWihsXirnABhd/jeRcfNtR0icxd/g1w9f28ozpzJzHlyNq3QxJDT6M26+4gY02O4CDH43H9lhYpvURqOWi6jjXMPf3R84NIYY6jTUln8G44sJf9U0sRIH7ulr/o7V9VSaK9esqH8pBoyLlxTcVmO3ve9hYeoGl0BujfX6NA26Eb0GX4CSAF9GayGA8AmiiyVbrJ+y5DCL9hNjNF9kST7JNKmAdBKr3v terraform > /root/.ssh/authorized_keys
          echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPmV7bV8TinX0fDySCiCaQygXUNuOJAtv3+fghgknEw0Nkn84/RiOm3cbtzzbTNh0BxsASWy+1wjx2TFEjB45XUYhEPZvlycCnex8zmj9mJJwlRi7NMcBKVMLQV+H4LltcLXDTUSNpWnaPmfJxhQrlaaF3NkCUPrycxV5LgUJ6ZsoQ1lqp4G80a421djytKFM2PxN4R/6fK6g1K7eStMKn6vSXsJjhlEw7j5QmDQeYBsOiVUqodxGwywS/QwFjPMaB17G3ZsTMknEpxWhoh7a4dSuXKCX0Rd7jR3I+kRfqpcl7qKrybX5SvMF3zXAD+3N5yqAYIc7m4jwBn4or+HqT yoni@omniti.com >> /root/.ssh/authorized_keys
          echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCOZAvvd4r7P0wAzx4vIhO7WtwhCE+LySBjV5q9hgR70ccWjVCL+OaK2LqohlL4QdwMOSsUcybwekl3gVtIIMPhqfp+vWM2QeMUO7bnU69mawYkb0EhJLUfNgWihsXirnABhd/jeRcfNtR0icxd/g1w9f28ozpzJzHlyNq3QxJDT6M26+4gY02O4CDH43H9lhYpvURqOWi6jjXMPf3R84NIYY6jTUln8G44sJf9U0sRIH7ulr/o7V9VSaK9esqH8pBoyLlxTcVmO3ve9hYeoGl0BujfX6NA26Eb0GX4CSAF9GayGA8AmiiyVbrJ+y5DCL9hNjNF9kST7JNKmAdBKr3v terraform > {{lxc_user_home}}/.ssh/authorized_keys
          echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPmV7bV8TinX0fDySCiCaQygXUNuOJAtv3+fghgknEw0Nkn84/RiOm3cbtzzbTNh0BxsASWy+1wjx2TFEjB45XUYhEPZvlycCnex8zmj9mJJwlRi7NMcBKVMLQV+H4LltcLXDTUSNpWnaPmfJxhQrlaaF3NkCUPrycxV5LgUJ6ZsoQ1lqp4G80a421djytKFM2PxN4R/6fK6g1K7eStMKn6vSXsJjhlEw7j5QmDQeYBsOiVUqodxGwywS/QwFjPMaB17G3ZsTMknEpxWhoh7a4dSuXKCX0Rd7jR3I+kRfqpcl7qKrybX5SvMF3zXAD+3N5yqAYIc7m4jwBn4or+HqT yoni@omniti.com >> {{lxc_user_home}}/.ssh/authorized_keys
          echo StrictHostKeyChecking no > /root/.ssh/config
          echo StrictHostKeyChecking no > {{lxc_user_home}}/.ssh/config
          sudo service ssh restart
      register: lxc_container_info
      tags: test_only

        # dynamically update inventory to make it available down the playbook
    - name: register new container hostname
      add_host: name="{{lxc_container_info.lxc_container.ips[0]}}" groups="go-mistify-libvirt-test"
      tags: test_only

# Install as root, to setup ubuntu as a sudoer
- hosts: go-mistify-libvirt-test
  remote_user: root
  vars_files:
      - 'vars/vaulted_vars'
  roles:
    - yaegashi.blockinfile
    - { role: security, tags: security }
    - { role: general-slave-setup }

# Install as ubuntu
- hosts: go-mistify-libvirt-test
  remote_user: ubuntu
  sudo: yes
  roles:
    - { role: kbrebanov.unzip }
    - { role: bobbyrenwick.pip }
    - { role: install-common-python-packages }
    - role: gotansible.golang
      golang_version: 1.4.2
      golang_per_user: false
      tags: golang
    - { role: install-golang-dependencies, tags: ['golang'] }
    - { role: install-openvswitch }
    - { role: configure-mistify }
    - role: laggyluke.add-ssh-keys-from-github
      add_ssh_keys_from_github:
        usernames:
          - omniti-devops
  tasks:
    - name: Copy go test executor script to container
      template: src=templates/go_test_executor.py dest=/tmp/go_test_executor.py owner=ubuntu group=ubuntu mode=0755
      tags: test_only
    - name: Run go kvm tests
      shell: |
          export WORKSPACE={{lxc_user_home}}/workspace
          export GOPATH=$WORKSPACE
          export PATH=/usr/local/go/bin:$PATH
          export REPO={{mistify_agent_repo_name}}
          export CHECKOUT_DIR=$WORKSPACE/src/github.com/mistifyio/$REPO
          mkdir -p $WORKSPACE
          rm -rf $CHECKOUT_DIR
          cd $WORKSPACE
          git clone {{mistify_agent_repo_url}} $CHECKOUT_DIR
          python /tmp/go_test_executor.py
      tags: test_only
  handlers:
    - include: roles/common/handlers/main.yml
  tags:

- hosts: localhost
  connection: local
  tasks:
    - name: Copy test results to localhost
      shell: scp {{lxc_user}}@{{lxc_container_info.lxc_container.ips[0]}}:{{lxc_user_home}}/workspace/test_results.xml .
